# 记忆衰退功能使用指南 🧠

## 📖 功能概述

记忆衰退机制模拟人类记忆的自然遗忘过程，让 OpenMemory 更加智能和高效：

- **自动衰退**：基于时间和访问频率，记忆会自然衰退
- **智能归档**：衰退严重的记忆自动归档，保持系统高效
- **重要性权重**：重要记忆衰减更慢
- **灵活配置**：可自定义衰退速度和归档策略

---

## 🎯 核心概念

### 衰退分数 (Decay Score)

- **范围**：0.0 - 1.0
- **1.0**：完全新鲜的记忆
- **0.5**：中等衰退
- **0.0**：完全衰退

### 计算公式

```
衰退分数 = 时间衰减 × 访问加成 × 重要性权重
```

**时间衰减**：基于半衰期的指数衰减
```
时间衰减 = 0.5^(天数 / 半衰期)
```

**访问加成**：访问越多，衰减越慢
```
访问加成 = 1.0 + log(1 + 访问次数) × 0.2
```

**重要性权重**：0.5 + (重要性分数 × 0.5)

---

## 🚀 快速开始

### 1. 启用衰退功能

在 `api/.env` 文件中配置：

```env
# 启用记忆衰退
MEMORY_DECAY_ENABLED=true

# 半衰期：30天（记忆在30天后衰减到50%）
MEMORY_DECAY_HALF_LIFE_DAYS=30

# 自动归档阈值：0.1（衰退分数低于0.1自动归档）
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.1

# 更新时间：每天凌晨2点
MEMORY_DECAY_UPDATE_HOUR=2
MEMORY_DECAY_UPDATE_MINUTE=0
```

### 2. 运行数据库迁移

```bash
# 进入 API 容器
docker compose exec openmemory-api bash

# 运行迁移
alembic upgrade head

# 退出容器
exit
```

### 3. 重启服务

```bash
docker compose restart openmemory-api
```

---

## 📡 API 接口

### 1. 手动触发衰退更新

**接口**：`POST /api/v1/decay/trigger-update`

**请求体**：
```json
{
  "user_id": "user123",  // 可选，不填则更新所有用户
  "half_life_days": 30,
  "auto_archive": true,
  "archive_threshold": 0.1
}
```

**响应**：
```json
{
  "success": true,
  "message": "衰退更新完成",
  "updated_count": 150,
  "archived_count": 5,
  "statistics": {
    "total_memories": 150,
    "average_decay_score": 0.65,
    "high_decay_count": 80,
    "medium_decay_count": 60,
    "low_decay_count": 10
  }
}
```

**示例**：
```bash
curl -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user123",
    "half_life_days": 30,
    "auto_archive": true,
    "archive_threshold": 0.1
  }'
```

### 2. 查询衰退统计

**接口**：`GET /api/v1/decay/statistics?user_id=user123`

**响应**：
```json
{
  "success": true,
  "statistics": {
    "total_memories": 150,
    "average_decay_score": 0.65,
    "high_decay_count": 80,
    "medium_decay_count": 60,
    "low_decay_count": 10
  }
}
```

### 3. 获取调度器状态

**接口**：`GET /api/v1/decay/scheduler-status`

**响应**：
```json
{
  "success": true,
  "scheduler": {
    "enabled": true,
    "running": true,
    "next_run_time": "2025-12-04T02:00:00",
    "update_schedule": "02:00",
    "half_life_days": 30,
    "archive_threshold": 0.1,
    "jobs_count": 1
  }
}
```

### 4. 更新记忆重要性

**接口**：`POST /api/v1/decay/update-importance`

**请求体**：
```json
{
  "memory_id": "abc123",
  "user_id": "user123",
  "importance_score": 0.9
}
```

**重要性等级**：
- **1.0**：非常重要（几乎不衰退）
- **0.7-0.9**：重要
- **0.5**：普通（默认）
- **0.3-0.4**：不太重要
- **0.0-0.2**：不重要（快速衰退）

### 5. 恢复归档记忆

**接口**：`POST /api/v1/decay/restore-memory`

**请求体**：
```json
{
  "memory_id": "abc123",
  "user_id": "user123"
}
```

### 6. 查询衰退记忆列表

**接口**：`GET /api/v1/decay/decayed-memories?user_id=user123&threshold=0.3&limit=50`

**响应**：
```json
{
  "success": true,
  "count": 10,
  "threshold": 0.3,
  "memories": [
    {
      "id": "abc123",
      "content": "记忆内容...",
      "decay_score": 0.25,
      "importance_score": 0.5,
      "access_count": 2,
      "last_accessed_at": "2025-11-01T10:00:00",
      "created_at": "2025-10-01T10:00:00"
    }
  ]
}
```

---

## 🔧 配置参数详解

### MEMORY_DECAY_ENABLED
- **类型**：布尔值
- **默认**：true
- **说明**：是否启用记忆衰退功能

### MEMORY_DECAY_HALF_LIFE_DAYS
- **类型**：整数
- **默认**：30
- **范围**：1-365
- **说明**：半衰期天数，记忆在此时间后衰减到50%

**推荐值**：
- **7天**：快速衰退，适合临时信息
- **30天**：标准衰退，适合一般使用
- **90天**：慢速衰退，适合长期记忆
- **180天**：极慢衰退，适合重要信息

### MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD
- **类型**：浮点数
- **默认**：0.1
- **范围**：0.0-1.0
- **说明**：自动归档阈值

**推荐值**：
- **0.05**：激进归档，保持系统精简
- **0.1**：标准归档（推荐）
- **0.2**：保守归档，保留更多记忆

### MEMORY_DECAY_UPDATE_HOUR
- **类型**：整数
- **默认**：2
- **范围**：0-23
- **说明**：每天更新衰退分数的小时

---

## 📊 使用场景

### 场景 1：个人知识管理

**配置**：
```env
MEMORY_DECAY_HALF_LIFE_DAYS=60
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.15
```

**策略**：
- 重要笔记设置 `importance_score=0.9`
- 临时想法设置 `importance_score=0.3`
- 定期查看衰退记忆列表，决定是否保留

### 场景 2：客户服务系统

**配置**：
```env
MEMORY_DECAY_HALF_LIFE_DAYS=30
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.1
```

**策略**：
- 活跃客户的记忆自动保持新鲜（频繁访问）
- 不活跃客户的记忆自动归档
- 重要客户信息设置高重要性

### 场景 3：学习助手

**配置**：
```env
MEMORY_DECAY_HALF_LIFE_DAYS=14
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.2
```

**策略**：
- 模拟艾宾浩斯遗忘曲线
- 需要复习的知识点会自然浮现（衰退分数降低）
- 已掌握的知识（频繁访问）保持活跃

---

## 🎨 最佳实践

### 1. 合理设置重要性

```python
# 示例：根据内容类型设置重要性
importance_map = {
    "个人信息": 1.0,
    "工作任务": 0.9,
    "学习笔记": 0.7,
    "日常对话": 0.5,
    "临时想法": 0.3
}
```

### 2. 定期审查衰退记忆

```bash
# 每周查看衰退记忆
curl "http://localhost:8765/api/v1/decay/decayed-memories?user_id=user123&threshold=0.3"
```

### 3. 监控衰退统计

```bash
# 查看整体衰退情况
curl "http://localhost:8765/api/v1/decay/statistics?user_id=user123"
```

### 4. 手动触发更新（测试）

```bash
# 测试不同的半衰期
curl -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{"half_life_days": 15, "auto_archive": false}'
```

---

## 🔍 故障排查

### 问题 1：衰退功能未启动

**检查**：
```bash
# 查看调度器状态
curl "http://localhost:8765/api/v1/decay/scheduler-status"
```

**解决**：
1. 确认 `MEMORY_DECAY_ENABLED=true`
2. 检查日志：`docker compose logs -f openmemory-api`
3. 重启服务：`docker compose restart openmemory-api`

### 问题 2：数据库迁移失败

**解决**：
```bash
# 查看迁移状态
docker compose exec openmemory-api alembic current

# 手动运行迁移
docker compose exec openmemory-api alembic upgrade head
```

### 问题 3：衰退分数未更新

**检查**：
1. 确认调度器正在运行
2. 检查下次运行时间
3. 手动触发更新测试

---

## 📈 性能优化

### 大规模数据优化

对于超过 10 万条记忆的系统：

```env
# 增加批处理大小（在代码中修改）
# api/app/utils/decay.py
# batch_size=500  # 默认100

# 调整更新频率
MEMORY_DECAY_UPDATE_HOUR=3  # 避开高峰期
```

### 数据库索引

迁移文件已自动创建以下索引：
- `idx_memory_decay_score`
- `idx_memory_last_accessed`
- `idx_memory_state_decay`

---

## 🧪 测试验证

### 1. 创建测试记忆

```bash
curl -X POST "http://localhost:8765/api/v1/memories/" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user",
    "text": "这是一条测试记忆",
    "app": "test_app"
  }'
```

### 2. 手动触发衰退更新

```bash
curl -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user",
    "half_life_days": 1,
    "auto_archive": false
  }'
```

### 3. 查看衰退分数

```bash
curl "http://localhost:8765/api/v1/decay/statistics?user_id=test_user"
```

---

## 📚 相关文件

- **模型定义**：`api/app/models.py`
- **衰退算法**：`api/app/utils/decay.py`
- **调度器**：`api/app/tasks/decay_scheduler.py`
- **API路由**：`api/app/routers/decay.py`
- **数据库迁移**：`api/alembic/versions/add_memory_decay_fields.py`

---

## ❓ 常见问题

**Q: 衰退功能会删除记忆吗？**
A: 不会。衰退功能只会将记忆标记为"归档"状态，可以随时恢复。

**Q: 如何禁用衰退功能？**
A: 设置 `MEMORY_DECAY_ENABLED=false` 并重启服务。

**Q: 衰退分数如何影响搜索？**
A: 衰退分数可以作为搜索结果排序的参考因素（需要在搜索逻辑中实现）。

**Q: 可以为不同用户设置不同的衰退策略吗？**
A: 当前版本使用全局配置，未来版本可以支持用户级配置。

---

## 🎉 总结

记忆衰退功能让 OpenMemory 更加智能：

✅ **自动管理**：无需手动清理旧记忆
✅ **性能优化**：保持系统高效运行
✅ **灵活配置**：适应不同使用场景
✅ **可恢复性**：归档的记忆可以随时恢复

开始使用记忆衰退功能，让你的 AI 助手更加智能！🚀