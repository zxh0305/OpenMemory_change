# ç‹¬ç«‹å½’æ¡£è¡¨å®ç°è¯´æ˜ ğŸ“¦

## ğŸ¯ è®¾è®¡ç›®æ ‡

å°†è¡°é€€åçš„è®°å¿†å­˜å‚¨åœ¨**ç‹¬ç«‹çš„å½’æ¡£è¡¨** `archived_memories` ä¸­ï¼Œä¸æ´»è·ƒè®°å¿†è¡¨ `memories` å®Œå…¨åˆ†ç¦»ã€‚

---

## ğŸ“Š è¡¨ç»“æ„è®¾è®¡

### 1. æ´»è·ƒè®°å¿†è¡¨ (memories)
å­˜å‚¨æ‰€æœ‰æ´»è·ƒçŠ¶æ€çš„è®°å¿†

```sql
CREATE TABLE memories (
    id VARCHAR(32) PRIMARY KEY,
    user_id VARCHAR(32) NOT NULL,
    app_id VARCHAR(32) NOT NULL,
    content TEXT NOT NULL,
    vector TEXT,
    metadata JSON,
    state ENUM('active', 'paused', 'deleted'),  -- ä¸åŒ…å« archived
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    -- è¡°é€€ç›¸å…³å­—æ®µ
    decay_score FLOAT DEFAULT 1.0,
    last_accessed_at DATETIME,
    access_count INT DEFAULT 0,
    importance_score FLOAT DEFAULT 0.5,
    
    INDEX idx_memory_user_state (user_id, state),
    INDEX idx_memory_decay_score (decay_score)
);
```

### 2. å½’æ¡£è®°å¿†è¡¨ (archived_memories)
**ç‹¬ç«‹å­˜å‚¨**è¡°é€€åçš„è®°å¿†

```sql
CREATE TABLE archived_memories (
    id VARCHAR(32) PRIMARY KEY,  -- ä¿æŒåŸè®°å¿†ID
    user_id VARCHAR(32) NOT NULL,
    app_id VARCHAR(32) NOT NULL,
    content TEXT NOT NULL,
    vector TEXT,
    metadata JSON,
    
    -- åŸå§‹æ—¶é—´ä¿¡æ¯
    created_at DATETIME NOT NULL,  -- åŸå§‹åˆ›å»ºæ—¶é—´
    updated_at DATETIME NOT NULL,  -- åŸå§‹æ›´æ–°æ—¶é—´
    
    -- å½’æ¡£ä¿¡æ¯
    archived_at DATETIME NOT NULL,  -- å½’æ¡£æ—¶é—´
    archived_from_state ENUM('active', 'paused'),  -- å½’æ¡£å‰çŠ¶æ€
    
    -- è¡°é€€ä¿¡æ¯å¿«ç…§
    decay_score_at_archive FLOAT NOT NULL,  -- å½’æ¡£æ—¶çš„è¡°é€€åˆ†æ•°
    last_accessed_at DATETIME,
    access_count INT DEFAULT 0,
    importance_score FLOAT DEFAULT 0.5,
    
    -- åˆ†ç±»å¿«ç…§ï¼ˆJSONå­˜å‚¨ï¼‰
    categories_snapshot JSON,
    
    INDEX idx_archived_user_time (user_id, archived_at),
    INDEX idx_archived_decay (decay_score_at_archive)
);
```

---

## ğŸ”„ è®°å¿†æµè½¬è¿‡ç¨‹

### å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ›å»ºæ–°è®°å¿†                            â”‚
â”‚                       â†“                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚              â”‚ memories è¡¨  â”‚                           â”‚
â”‚              â”‚ state=active â”‚                           â”‚
â”‚              â”‚ decay=1.0    â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                     â”‚                                    â”‚
â”‚              æ—¶é—´æ¨ç§»ï¼Œæœªè®¿é—®                            â”‚
â”‚                     â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚              â”‚ memories è¡¨  â”‚                           â”‚
â”‚              â”‚ state=active â”‚                           â”‚
â”‚              â”‚ decay=0.5    â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                     â”‚                                    â”‚
â”‚         decay_score < 0.1 (é˜ˆå€¼)                        â”‚
â”‚                     â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚              â”‚  ç§»åŠ¨æ“ä½œ    â”‚                           â”‚
â”‚              â”‚  1. å¤åˆ¶æ•°æ® â”‚                           â”‚
â”‚              â”‚  2. åˆ é™¤åŸè®°å½•â”‚                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                     â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚ archived_memories è¡¨â”‚                    â”‚
â”‚              â”‚ ç‹¬ç«‹å­˜å‚¨            â”‚                    â”‚
â”‚              â”‚ decay=0.08          â”‚                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                     â”‚                                    â”‚
â”‚              ç”¨æˆ·è¯·æ±‚æ¢å¤                                â”‚
â”‚                     â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚              â”‚  æ¢å¤æ“ä½œ    â”‚                           â”‚
â”‚              â”‚  1. å¤åˆ¶å›å» â”‚                           â”‚
â”‚              â”‚  2. åˆ é™¤å½’æ¡£ â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                     â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚              â”‚ memories è¡¨  â”‚                           â”‚
â”‚              â”‚ state=active â”‚                           â”‚
â”‚              â”‚ decay=1.0    â”‚ (é‡ç½®)                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» æ ¸å¿ƒå®ç°

### 1. å½’æ¡£æ“ä½œï¼ˆç§»åŠ¨åˆ°å½’æ¡£è¡¨ï¼‰

æ–‡ä»¶ï¼š[`api/app/utils/decay_with_archive_table.py`](api/app/utils/decay_with_archive_table.py:119)

```python
def move_memory_to_archive(db: Session, memory: Memory) -> ArchivedMemory:
    """
    å°†è®°å¿†ä» memories è¡¨ç§»åŠ¨åˆ° archived_memories è¡¨
    """
    # 1. è·å–åˆ†ç±»ä¿¡æ¯
    categories = [cat.name for cat in memory.categories]
    
    # 2. åˆ›å»ºå½’æ¡£è®°å½•
    archived_memory = ArchivedMemory(
        id=memory.id,  # ä¿æŒç›¸åŒID
        user_id=memory.user_id,
        app_id=memory.app_id,
        content=memory.content,
        # ... å…¶ä»–å­—æ®µ
        categories_snapshot=categories  # ä¿å­˜åˆ†ç±»å¿«ç…§
    )
    db.add(archived_memory)
    
    # 3. è®°å½•çŠ¶æ€å˜æ›´å†å²
    history = MemoryStatusHistory(...)
    db.add(history)
    
    # 4. åˆ é™¤åŸè®°å½•
    db.delete(memory)
    
    db.commit()
    return archived_memory
```

### 2. æ¢å¤æ“ä½œï¼ˆç§»å›æ´»è·ƒè¡¨ï¼‰

```python
def restore_archived_memory(db: Session, memory_id: str, user_id: str) -> bool:
    """
    ä»å½’æ¡£è¡¨æ¢å¤è®°å¿†åˆ°æ´»è·ƒè¡¨
    """
    # 1. æŸ¥æ‰¾å½’æ¡£è®°å¿†
    archived_memory = db.query(ArchivedMemory).filter(...).first()
    
    # 2. åˆ›å»ºæ–°çš„æ´»è·ƒè®°å¿†
    memory = Memory(
        id=archived_memory.id,
        # ... å¤åˆ¶æ‰€æœ‰å­—æ®µ
        decay_score=1.0,  # é‡ç½®è¡°é€€åˆ†æ•°
        state=MemoryState.active
    )
    db.add(memory)
    
    # 3. æ¢å¤åˆ†ç±»å…³è”
    for cat_name in archived_memory.categories_snapshot:
        category = db.query(Category).filter(...).first()
        memory.categories.append(category)
    
    # 4. åˆ é™¤å½’æ¡£è®°å½•
    db.delete(archived_memory)
    
    db.commit()
    return True
```

---

## ğŸ”Œ API æ¥å£

### 1. æŸ¥è¯¢å½’æ¡£è®°å¿†åˆ—è¡¨

```bash
GET /api/v1/archived-memories/?user_id=user123&limit=50&offset=0
```

**å“åº”ï¼š**
```json
[
  {
    "id": "abc123",
    "content": "è®°å¿†å†…å®¹...",
    "created_at": "2025-10-01T10:00:00",
    "archived_at": "2025-12-01T02:00:00",
    "decay_score_at_archive": 0.08,
    "importance_score": 0.5,
    "access_count": 2,
    "categories": ["å·¥ä½œ", "é¡¹ç›®"]
  }
]
```

### 2. è·å–å•ä¸ªå½’æ¡£è®°å¿†è¯¦æƒ…

```bash
GET /api/v1/archived-memories/abc123?user_id=user123
```

### 3. æ¢å¤å½’æ¡£è®°å¿†

```bash
POST /api/v1/archived-memories/restore
Content-Type: application/json

{
  "memory_id": "abc123",
  "user_id": "user123"
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "è®°å¿†å·²ä»å½’æ¡£è¡¨æ¢å¤åˆ°æ´»è·ƒè¡¨",
  "memory_id": "abc123",
  "details": {
    "from_table": "archived_memories",
    "to_table": "memories",
    "new_decay_score": 1.0
  }
}
```

### 4. æ°¸ä¹…åˆ é™¤å½’æ¡£è®°å¿†

```bash
DELETE /api/v1/archived-memories/abc123?user_id=user123
```

**è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼**

### 5. å½’æ¡£ç»Ÿè®¡ä¿¡æ¯

```bash
GET /api/v1/archived-memories/stats/summary?user_id=user123
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "total_archived": 25,
  "by_decay_score": {
    "very_low": 15,
    "low": 8,
    "medium": 2
  },
  "by_app": [
    {"app_id": "app1", "count": 10},
    {"app_id": "app2", "count": 15}
  ]
}
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. âœ… [`api/app/models.py`](api/app/models.py:139) - æ·»åŠ  `ArchivedMemory` æ¨¡å‹
2. âœ… [`api/alembic/versions/create_archived_memories_table.py`](api/alembic/versions/create_archived_memories_table.py) - åˆ›å»ºå½’æ¡£è¡¨è¿ç§»
3. âœ… [`api/app/utils/decay_with_archive_table.py`](api/app/utils/decay_with_archive_table.py) - ç‹¬ç«‹å½’æ¡£è¡¨çš„è¡°é€€é€»è¾‘
4. âœ… [`api/app/routers/archived_memories.py`](api/app/routers/archived_memories.py) - å½’æ¡£è®°å¿†APIè·¯ç”±
5. âœ… [`api/main.py`](api/main.py:8) - é›†æˆå½’æ¡£è®°å¿†è·¯ç”±

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# è¿›å…¥å®¹å™¨
docker compose exec openmemory-api bash

# è¿è¡Œè¿ç§»ï¼ˆæŒ‰é¡ºåºï¼‰
alembic upgrade add_memory_decay_fields
alembic upgrade create_archived_memories_table

# é€€å‡º
exit
```

### 2. é‡å¯æœåŠ¡

```bash
docker compose restart openmemory-api
```

### 3. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å½’æ¡£è¡¨æ˜¯å¦åˆ›å»º
docker compose exec openmemory-api bash
sqlite3 openmemory.db "SELECT name FROM sqlite_master WHERE type='table' AND name='archived_memories';"
```

---

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥çœ‹ä¸¤ä¸ªè¡¨çš„è®°å¿†åˆ†å¸ƒ

```sql
-- æ´»è·ƒè®°å¿†ç»Ÿè®¡
SELECT 
    state,
    COUNT(*) as count,
    AVG(decay_score) as avg_decay
FROM memories 
GROUP BY state;

-- å½’æ¡£è®°å¿†ç»Ÿè®¡
SELECT 
    COUNT(*) as total_archived,
    AVG(decay_score_at_archive) as avg_decay_at_archive,
    MIN(archived_at) as first_archived,
    MAX(archived_at) as last_archived
FROM archived_memories;
```

### æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„è®°å¿†åˆ†å¸ƒ

```sql
-- ç”¨æˆ·çš„æ´»è·ƒè®°å¿†
SELECT COUNT(*) FROM memories 
WHERE user_id = 'user123' AND state = 'active';

-- ç”¨æˆ·çš„å½’æ¡£è®°å¿†
SELECT COUNT(*) FROM archived_memories 
WHERE user_id = 'user123';
```

---

## ğŸ’¡ ä¼˜åŠ¿å¯¹æ¯”

### ç‹¬ç«‹å½’æ¡£è¡¨ vs åŒè¡¨çŠ¶æ€æ ‡è®°

| ç‰¹æ€§ | ç‹¬ç«‹å½’æ¡£è¡¨ | åŒè¡¨çŠ¶æ€æ ‡è®° |
|------|-----------|-------------|
| **æŸ¥è¯¢æ€§èƒ½** | âœ… ä¼˜ç§€ï¼ˆè¡¨æ›´å°ï¼‰ | âš ï¸ ä¸€èˆ¬ï¼ˆéœ€è¿‡æ»¤ï¼‰ |
| **æ•°æ®éš”ç¦»** | âœ… å®Œå…¨éš”ç¦» | âŒ æ··åœ¨ä¸€èµ· |
| **ç´¢å¼•æ•ˆç‡** | âœ… é«˜æ•ˆ | âš ï¸ ç´¢å¼•åŒ…å«å½’æ¡£æ•°æ® |
| **å¤‡ä»½ç­–ç•¥** | âœ… å¯åˆ†åˆ«å¤‡ä»½ | âŒ å¿…é¡»ä¸€èµ·å¤‡ä»½ |
| **æ¸…ç†æ“ä½œ** | âœ… ç›´æ¥åˆ é™¤è¡¨ | âš ï¸ éœ€è¦WHEREè¿‡æ»¤ |
| **å­˜å‚¨ä¼˜åŒ–** | âœ… å¯ç”¨ä¸åŒå­˜å‚¨ | âŒ åŒä¸€å­˜å‚¨ |
| **å®ç°å¤æ‚åº¦** | âš ï¸ ç¨å¤æ‚ | âœ… ç®€å• |

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ç­–ç•¥

```sql
-- æ´»è·ƒè¡¨ç´¢å¼•ï¼ˆä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢ï¼‰
CREATE INDEX idx_memory_user_state ON memories(user_id, state);
CREATE INDEX idx_memory_decay_score ON memories(decay_score);

-- å½’æ¡£è¡¨ç´¢å¼•ï¼ˆä¼˜åŒ–å½’æ¡£æŸ¥è¯¢ï¼‰
CREATE INDEX idx_archived_user_time ON archived_memories(user_id, archived_at);
CREATE INDEX idx_archived_decay ON archived_memories(decay_score_at_archive);
```

### 2. åˆ†åŒºç­–ç•¥ï¼ˆå¯é€‰ï¼‰

å¯¹äºå¤§è§„æ¨¡æ•°æ®ï¼Œå¯ä»¥å¯¹å½’æ¡£è¡¨æŒ‰æ—¶é—´åˆ†åŒºï¼š

```sql
-- æŒ‰æœˆåˆ†åŒºå½’æ¡£è¡¨
CREATE TABLE archived_memories_2025_01 PARTITION OF archived_memories
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 3. å½’æ¡£æ•°æ®å‹ç¼©

```sql
-- å¯¹å½’æ¡£è¡¨å¯ç”¨å‹ç¼©ï¼ˆMySQLï¼‰
ALTER TABLE archived_memories ROW_FORMAT=COMPRESSED;
```

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. å®šæœŸæ¸…ç†ç­–ç•¥

```python
# åˆ é™¤1å¹´å‰çš„å½’æ¡£è®°å¿†
DELETE FROM archived_memories 
WHERE archived_at < NOW() - INTERVAL '1 year';
```

### 2. æ‰¹é‡æ¢å¤

```python
# æ¢å¤é‡è¦çš„å½’æ¡£è®°å¿†
SELECT id FROM archived_memories 
WHERE importance_score > 0.8 
AND archived_at > NOW() - INTERVAL '30 days';
```

### 3. ç›‘æ§æŒ‡æ ‡

- æ´»è·ƒè¡¨å¤§å°
- å½’æ¡£è¡¨å¤§å°
- æ¯æ—¥å½’æ¡£æ•°é‡
- æ¢å¤æ“ä½œé¢‘ç‡

---

## âœ… æ€»ç»“

### æ ¸å¿ƒç‰¹ç‚¹

1. **å®Œå…¨åˆ†ç¦»**ï¼šæ´»è·ƒè®°å¿†å’Œå½’æ¡£è®°å¿†å­˜å‚¨åœ¨ä¸åŒè¡¨
2. **æ•°æ®å®Œæ•´**ï¼šå½’æ¡£æ—¶ä¿å­˜æ‰€æœ‰ä¿¡æ¯å’Œå¿«ç…§
3. **å¯æ¢å¤æ€§**ï¼šéšæ—¶å¯ä»¥æ¢å¤åˆ°æ´»è·ƒè¡¨
4. **é«˜æ€§èƒ½**ï¼šæŸ¥è¯¢æ´»è·ƒè®°å¿†æ›´å¿«
5. **æ˜“ç®¡ç†**ï¼šå¯ä»¥ç‹¬ç«‹å¤‡ä»½ã€æ¸…ç†å½’æ¡£æ•°æ®

### æ•°æ®æµå‘

```
memories è¡¨ (æ´»è·ƒ)
    â†“ è¡°é€€ä¸¥é‡
archived_memories è¡¨ (å½’æ¡£)
    â†“ ç”¨æˆ·æ¢å¤
memories è¡¨ (æ´»è·ƒï¼Œé‡ç½®è¡°é€€åˆ†æ•°)
```

### å…³é”®ä¼˜åŠ¿

âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šæ´»è·ƒè¡¨æ›´å°ï¼ŒæŸ¥è¯¢æ›´å¿«
âœ… **æ•°æ®éš”ç¦»**ï¼šå½’æ¡£æ•°æ®ä¸å½±å“æ—¥å¸¸æ“ä½œ
âœ… **çµæ´»ç®¡ç†**ï¼šå¯ä»¥ç‹¬ç«‹å¤„ç†å½’æ¡£æ•°æ®
âœ… **å­˜å‚¨ä¼˜åŒ–**ï¼šå¯ä»¥ä½¿ç”¨ä¸åŒçš„å­˜å‚¨ç­–ç•¥
âœ… **æ¸…æ™°æ¶æ„**ï¼šæ•°æ®æµå‘æ¸…æ™°æ˜ç¡®

**ç‹¬ç«‹å½’æ¡£è¡¨æ˜¯å¤§è§„æ¨¡è®°å¿†ç®¡ç†çš„æœ€ä½³å®è·µï¼** ğŸ‰