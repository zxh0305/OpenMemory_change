# è¡°é€€åˆ†æ•°æ˜¾ç¤ºæµ‹è¯•æŒ‡å— ğŸ§ª

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬æŒ‡å—å¸®åŠ©æ‚¨å¿«é€ŸéªŒè¯è¡°é€€åˆ†æ•°åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€APIå’ŒWebç•Œé¢çš„æµ‹è¯•ã€‚

---

## ğŸ”§ å‰ç½®å‡†å¤‡

### 1. ç¡®ä¿æ•°æ®åº“è¿ç§»å·²å®Œæˆ

```bash
# è¿›å…¥APIå®¹å™¨
docker compose exec openmemory-api bash

# è¿è¡Œæ•°æ®åº“è¿ç§»
alembic upgrade head

# éªŒè¯è¿ç§»æˆåŠŸ
alembic current

# é€€å‡ºå®¹å™¨
exit
```

### 2. é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker compose restart

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ
docker compose logs -f openmemory-api
```

---

## ğŸ—„ï¸ æ•°æ®åº“æµ‹è¯•

### æµ‹è¯•1ï¼šæ£€æŸ¥è¡¨ç»“æ„

```bash
# è¿›å…¥å®¹å™¨
docker compose exec openmemory-api bash

# æ‰“å¼€æ•°æ®åº“
sqlite3 openmemory.db

# æŸ¥çœ‹memoriesè¡¨ç»“æ„
.schema memories

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹å­—æ®µï¼š
# - decay_score FLOAT DEFAULT 1.0
# - importance_score FLOAT DEFAULT 0.5
# - access_count INTEGER DEFAULT 0
# - last_accessed_at TIMESTAMP

# é€€å‡º
.exit
exit
```

**é¢„æœŸç»“æœï¼š** âœ… è¡¨ä¸­åŒ…å«æ‰€æœ‰è¡°é€€ç›¸å…³å­—æ®µ

---

### æµ‹è¯•2ï¼šæŸ¥çœ‹ç°æœ‰è®°å¿†çš„è¡°é€€åˆ†æ•°

```bash
docker compose exec openmemory-api sqlite3 openmemory.db \
  "SELECT id, SUBSTR(content, 1, 30) as content, decay_score, importance_score, access_count 
   FROM memories 
   WHERE state='active' 
   LIMIT 5;"
```

**é¢„æœŸç»“æœï¼š** âœ… æ˜¾ç¤ºè®°å¿†åˆ—è¡¨åŠå…¶è¡°é€€åˆ†æ•°

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
abc123|è¿™æ˜¯ä¸€æ¡æµ‹è¯•è®°å¿†...|1.0|0.5|0
def456|å¦ä¸€æ¡è®°å¿†å†…å®¹...|0.85|0.7|5
```

---

### æµ‹è¯•3ï¼šæ‰‹åŠ¨æ’å…¥æµ‹è¯•æ•°æ®

```bash
docker compose exec openmemory-api sqlite3 openmemory.db <<EOF
-- æ›´æ–°ä¸€æ¡è®°å¿†çš„è¡°é€€åˆ†æ•°ç”¨äºæµ‹è¯•
UPDATE memories 
SET decay_score = 0.3, 
    importance_score = 0.8, 
    access_count = 10,
    last_accessed_at = datetime('now')
WHERE id = (SELECT id FROM memories WHERE state='active' LIMIT 1);

-- æŸ¥çœ‹æ›´æ–°ç»“æœ
SELECT id, decay_score, importance_score, access_count 
FROM memories 
WHERE state='active' 
LIMIT 1;
EOF
```

**é¢„æœŸç»“æœï¼š** âœ… æˆåŠŸæ›´æ–°å¹¶æ˜¾ç¤ºæ–°çš„è¡°é€€åˆ†æ•°

---

## ğŸ”Œ API æµ‹è¯•

### æµ‹è¯•4ï¼šè·å–å•ä¸ªè®°å¿†ï¼ˆåŒ…å«è¡°é€€åˆ†æ•°ï¼‰

```bash
# é¦–å…ˆè·å–ä¸€ä¸ªè®°å¿†ID
MEMORY_ID=$(docker compose exec openmemory-api sqlite3 openmemory.db \
  "SELECT id FROM memories WHERE state='active' LIMIT 1;")

# è°ƒç”¨APIè·å–è®°å¿†è¯¦æƒ…
curl -s "http://localhost:8765/api/v1/memories/${MEMORY_ID}" | jq
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å›çš„JSONåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
```json
{
  "id": "...",
  "text": "...",
  "decay_score": 0.85,
  "importance_score": 0.5,
  "access_count": 5,
  "last_accessed_at": 1733184000,
  ...
}
```

---

### æµ‹è¯•5ï¼šè·å–è®°å¿†åˆ—è¡¨ï¼ˆåŒ…å«è¡°é€€åˆ†æ•°ï¼‰

```bash
# è·å–è®°å¿†åˆ—è¡¨
curl -s "http://localhost:8765/api/v1/memories/?user_id=test_user&page=1&size=5" | jq '.items[0]'
```

**é¢„æœŸç»“æœï¼š** âœ… åˆ—è¡¨ä¸­æ¯æ¡è®°å¿†éƒ½åŒ…å«è¡°é€€å­—æ®µ

---

### æµ‹è¯•6ï¼šè·å–è¡°é€€ç»Ÿè®¡

```bash
# è·å–è¡°é€€ç»Ÿè®¡ä¿¡æ¯
curl -s "http://localhost:8765/api/v1/decay/statistics?user_id=test_user" | jq
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å›ç»Ÿè®¡ä¿¡æ¯ï¼š
```json
{
  "success": true,
  "statistics": {
    "total_active_memories": 150,
    "total_archived_memories": 25,
    "average_decay_score": 0.65,
    "high_decay_count": 80,
    "medium_decay_count": 60,
    "low_decay_count": 10
  }
}
```

---

### æµ‹è¯•7ï¼šè·å–è¡°é€€è®°å¿†åˆ—è¡¨

```bash
# è·å–è¡°é€€åˆ†æ•°ä½äº0.3çš„è®°å¿†
curl -s "http://localhost:8765/api/v1/decay/decayed-memories?user_id=test_user&threshold=0.3&limit=10" | jq
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å›è¡°é€€è®°å¿†åˆ—è¡¨

---

### æµ‹è¯•8ï¼šæ‰‹åŠ¨è§¦å‘è¡°é€€æ›´æ–°

```bash
# è§¦å‘è¡°é€€æ›´æ–°
curl -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test_user"}' | jq
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å›æ›´æ–°æˆåŠŸä¿¡æ¯ï¼š
```json
{
  "success": true,
  "message": "Decay scores updated successfully",
  "updated_count": 150
}
```

---

### æµ‹è¯•9ï¼šæ›´æ–°è®°å¿†é‡è¦æ€§

```bash
# è·å–ä¸€ä¸ªè®°å¿†ID
MEMORY_ID=$(docker compose exec openmemory-api sqlite3 openmemory.db \
  "SELECT id FROM memories WHERE state='active' LIMIT 1;")

# æ›´æ–°é‡è¦æ€§åˆ†æ•°
curl -X POST "http://localhost:8765/api/v1/decay/update-importance" \
  -H "Content-Type: application/json" \
  -d "{
    \"memory_id\": \"${MEMORY_ID}\",
    \"importance_score\": 0.9
  }" | jq
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å›æ›´æ–°æˆåŠŸä¿¡æ¯

---

## ğŸŒ Webç•Œé¢æµ‹è¯•

### æµ‹è¯•10ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥

1. æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:3000`
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
3. åˆ‡æ¢åˆ° Network æ ‡ç­¾
4. åˆ·æ–°é¡µé¢ï¼ŒæŸ¥çœ‹è®°å¿†åˆ—è¡¨çš„APIè¯·æ±‚
5. ç‚¹å‡» `/api/v1/memories/` è¯·æ±‚
6. æŸ¥çœ‹ Response æ ‡ç­¾

**é¢„æœŸç»“æœï¼š** âœ… å“åº”æ•°æ®åŒ…å«è¡°é€€å­—æ®µï¼š
```json
{
  "items": [
    {
      "id": "...",
      "content": "...",
      "decay_score": 0.85,
      "importance_score": 0.5,
      "access_count": 5,
      "last_accessed_at": 1733184000
    }
  ]
}
```

---

### æµ‹è¯•11ï¼šæ§åˆ¶å°æ—¥å¿—æ£€æŸ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// è·å–è®°å¿†æ•°æ®
fetch('/api/v1/memories/?user_id=test_user&page=1&size=1')
  .then(r => r.json())
  .then(data => {
    console.log('è®°å¿†æ•°æ®:', data.items[0]);
    console.log('è¡°é€€åˆ†æ•°:', data.items[0].decay_score);
    console.log('é‡è¦æ€§:', data.items[0].importance_score);
    console.log('è®¿é—®æ¬¡æ•°:', data.items[0].access_count);
  });
```

**é¢„æœŸç»“æœï¼š** âœ… æ§åˆ¶å°æ˜¾ç¤ºæ‰€æœ‰è¡°é€€å­—æ®µ

---

## ğŸ”„ å®Œæ•´æµç¨‹æµ‹è¯•

### æµ‹è¯•12ï¼šç«¯åˆ°ç«¯æµ‹è¯•

```bash
#!/bin/bash
# ä¿å­˜ä¸º test_decay_e2e.sh

echo "=== ç«¯åˆ°ç«¯è¡°é€€åŠŸèƒ½æµ‹è¯• ==="

# 1. åˆ›å»ºæµ‹è¯•è®°å¿†
echo "1. åˆ›å»ºæµ‹è¯•è®°å¿†..."
RESPONSE=$(curl -s -X POST "http://localhost:8765/api/v1/memories/" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user",
    "text": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•è®°å¿†ï¼Œç”¨äºéªŒè¯è¡°é€€åŠŸèƒ½",
    "app": "test_app"
  }')

MEMORY_ID=$(echo $RESPONSE | jq -r '.id')
echo "âœ… è®°å¿†å·²åˆ›å»º: $MEMORY_ID"

# 2. è·å–è®°å¿†è¯¦æƒ…
echo -e "\n2. è·å–è®°å¿†è¯¦æƒ…..."
curl -s "http://localhost:8765/api/v1/memories/${MEMORY_ID}" | jq '{
  id: .id,
  decay_score: .decay_score,
  importance_score: .importance_score,
  access_count: .access_count
}'

# 3. æ›´æ–°é‡è¦æ€§
echo -e "\n3. æ›´æ–°é‡è¦æ€§ä¸º0.9..."
curl -s -X POST "http://localhost:8765/api/v1/decay/update-importance" \
  -H "Content-Type: application/json" \
  -d "{
    \"memory_id\": \"${MEMORY_ID}\",
    \"importance_score\": 0.9
  }" | jq

# 4. è§¦å‘è¡°é€€æ›´æ–°
echo -e "\n4. è§¦å‘è¡°é€€æ›´æ–°..."
curl -s -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test_user"}' | jq

# 5. å†æ¬¡è·å–è®°å¿†è¯¦æƒ…
echo -e "\n5. éªŒè¯æ›´æ–°åçš„æ•°æ®..."
curl -s "http://localhost:8765/api/v1/memories/${MEMORY_ID}" | jq '{
  id: .id,
  decay_score: .decay_score,
  importance_score: .importance_score,
  access_count: .access_count
}'

# 6. è·å–ç»Ÿè®¡ä¿¡æ¯
echo -e "\n6. è·å–ç»Ÿè®¡ä¿¡æ¯..."
curl -s "http://localhost:8765/api/v1/decay/statistics?user_id=test_user" | jq

echo -e "\n=== æµ‹è¯•å®Œæˆ ==="
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
chmod +x test_decay_e2e.sh
./test_decay_e2e.sh
```

**é¢„æœŸç»“æœï¼š** âœ… æ‰€æœ‰æ­¥éª¤æˆåŠŸæ‰§è¡Œï¼Œæ•°æ®æ­£ç¡®æ›´æ–°

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•13ï¼šæ‰¹é‡è¡°é€€æ›´æ–°æ€§èƒ½

```bash
# æµ‹è¯•æ‰¹é‡æ›´æ–°æ€§èƒ½
time curl -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test_user"}'
```

**é¢„æœŸç»“æœï¼š** âœ… æ›´æ–°æ—¶é—´åˆç†ï¼ˆå–å†³äºè®°å¿†æ•°é‡ï¼‰

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šAPIè¿”å›çš„æ•°æ®ä¸åŒ…å«è¡°é€€å­—æ®µ

**æ£€æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æ£€æŸ¥æ•°æ®åº“è¿ç§»
docker compose exec openmemory-api alembic current

# 2. æ£€æŸ¥è¡¨ç»“æ„
docker compose exec openmemory-api sqlite3 openmemory.db ".schema memories"

# 3. æ£€æŸ¥APIä»£ç 
docker compose exec openmemory-api cat /app/app/schemas.py | grep decay_score
```

**è§£å†³æ–¹æ¡ˆï¼š**
- è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š`alembic upgrade head`
- é‡å¯æœåŠ¡ï¼š`docker compose restart`

---

### é—®é¢˜2ï¼šè¡°é€€åˆ†æ•°å§‹ç»ˆä¸º1.0

**æ£€æŸ¥æ­¥éª¤ï¼š**
```bash
# æ£€æŸ¥å®šæ—¶ä»»åŠ¡æ˜¯å¦è¿è¡Œ
curl "http://localhost:8765/api/v1/decay/scheduler-status"

# æ‰‹åŠ¨è§¦å‘æ›´æ–°
curl -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test_user"}'
```

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿ç¯å¢ƒå˜é‡ `MEMORY_DECAY_ENABLED=true`
- æ£€æŸ¥æ—¥å¿—ï¼š`docker compose logs openmemory-api | grep decay`

---

### é—®é¢˜3ï¼šWebç•Œé¢ä¸æ˜¾ç¤ºè¡°é€€åˆ†æ•°

**æ£€æŸ¥æ­¥éª¤ï¼š**
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
2. æ£€æŸ¥Networkæ ‡ç­¾ä¸­çš„APIå“åº”
3. æ£€æŸ¥Consoleæ ‡ç­¾ä¸­çš„é”™è¯¯ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®è®¤APIè¿”å›åŒ…å«è¡°é€€å­—æ®µ
- æ£€æŸ¥å‰ç«¯ç»„ä»¶æ˜¯å¦æ­£ç¡®æ¸²æŸ“
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

å®Œæˆæ‰€æœ‰æµ‹è¯•åï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æ•°æ®åº“è¡¨åŒ…å«è¡°é€€å­—æ®µ
- [ ] å¯ä»¥åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢è¡°é€€åˆ†æ•°
- [ ] APIå•ä¸ªè®°å¿†æ¥å£è¿”å›è¡°é€€å­—æ®µ
- [ ] APIè®°å¿†åˆ—è¡¨æ¥å£è¿”å›è¡°é€€å­—æ®µ
- [ ] è¡°é€€ç»Ÿè®¡æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] è¡°é€€è®°å¿†åˆ—è¡¨æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] æ‰‹åŠ¨è§¦å‘æ›´æ–°åŠŸèƒ½æ­£å¸¸
- [ ] æ›´æ–°é‡è¦æ€§åŠŸèƒ½æ­£å¸¸
- [ ] æµè§ˆå™¨Networkæ˜¾ç¤ºè¡°é€€å­—æ®µ
- [ ] å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

---

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```markdown
# è¡°é€€åˆ†æ•°åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸï¼š** 2025-12-03
**æµ‹è¯•äººå‘˜ï¼š** [æ‚¨çš„åå­—]
**ç¯å¢ƒï¼š** Docker / æœ¬åœ°å¼€å‘

## æµ‹è¯•ç»“æœ

| æµ‹è¯•é¡¹ | çŠ¶æ€ | å¤‡æ³¨ |
|--------|------|------|
| æ•°æ®åº“ç»“æ„ | âœ… | æ‰€æœ‰å­—æ®µæ­£å¸¸ |
| APIå•ä¸ªè®°å¿† | âœ… | è¿”å›è¡°é€€å­—æ®µ |
| APIè®°å¿†åˆ—è¡¨ | âœ… | è¿”å›è¡°é€€å­—æ®µ |
| è¡°é€€ç»Ÿè®¡ | âœ… | æ•°æ®å‡†ç¡® |
| æ‰‹åŠ¨æ›´æ–° | âœ… | åŠŸèƒ½æ­£å¸¸ |
| å®šæ—¶ä»»åŠ¡ | âœ… | æŒ‰æ—¶æ‰§è¡Œ |
| Webç•Œé¢ | âš ï¸ | éœ€è¦å‰ç«¯ä¿®æ”¹ |

## é—®é¢˜è®°å½•

1. [é—®é¢˜æè¿°]
   - è§£å†³æ–¹æ¡ˆï¼š[...]
   - çŠ¶æ€ï¼šå·²è§£å†³/å¾…è§£å†³

## æ€»ç»“

è¡°é€€åˆ†æ•°åŠŸèƒ½åŸºæœ¬æ­£å¸¸ï¼ŒAPIå±‚é¢å®Œå…¨å¯ç”¨ã€‚
Webç•Œé¢éœ€è¦æŒ‰ç…§ã€Šå‰ç«¯æ˜¾ç¤ºè¡°é€€åˆ†æ•°æŒ‡å—.mdã€‹è¿›è¡Œä¿®æ”¹ã€‚
```

---

## ğŸ¯ å¿«é€ŸéªŒè¯å‘½ä»¤

```bash
# ä¸€é”®éªŒè¯æ‰€æœ‰åŠŸèƒ½
echo "=== å¿«é€ŸéªŒè¯ ==="
echo "1. æ•°æ®åº“å­—æ®µï¼š"
docker compose exec openmemory-api sqlite3 openmemory.db \
  "SELECT decay_score, importance_score FROM memories LIMIT 1;"

echo -e "\n2. APIè¿”å›ï¼š"
curl -s "http://localhost:8765/api/v1/memories/?user_id=test_user&page=1&size=1" \
  | jq '.items[0] | {decay_score, importance_score, access_count}'

echo -e "\n3. ç»Ÿè®¡ä¿¡æ¯ï¼š"
curl -s "http://localhost:8765/api/v1/decay/statistics?user_id=test_user" \
  | jq '.statistics | {average_decay_score, high_decay_count}'

echo -e "\n=== éªŒè¯å®Œæˆ ==="
```

---

**æŒ‰ç…§æœ¬æŒ‡å—å®Œæˆæµ‹è¯•ï¼Œç¡®ä¿è¡°é€€åˆ†æ•°åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼** ğŸ§ªâœ…