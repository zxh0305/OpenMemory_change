# OpenMemory è®°å¿†å­˜å‚¨ä¸æŸ¥è¯¢è°ƒç”¨æŒ‡å— ğŸ“š

> å®Œæ•´çš„ API å’Œ MCP è°ƒç”¨æŒ‡å—ï¼ŒåŒ…æ‹¬è®°å¿†å­˜å‚¨ã€æŸ¥è¯¢ã€è¡°é€€ç®¡ç†ã€å½’æ¡£è®°å¿†ç­‰æ‰€æœ‰åŠŸèƒ½

## ğŸ“– ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [API è°ƒç”¨æ–¹å¼](#api-è°ƒç”¨æ–¹å¼)
  - [è®°å¿†å­˜å‚¨](#1-è®°å¿†å­˜å‚¨)
  - [è®°å¿†æŸ¥è¯¢](#2-è®°å¿†æŸ¥è¯¢)
  - [è®°å¿†æ›´æ–°](#3-è®°å¿†æ›´æ–°)
  - [è®°å¿†åˆ é™¤](#4-è®°å¿†åˆ é™¤)
  - [è®°å¿†è¡°é€€ç®¡ç†](#5-è®°å¿†è¡°é€€ç®¡ç†)
  - [å½’æ¡£è®°å¿†ç®¡ç†](#6-å½’æ¡£è®°å¿†ç®¡ç†)
- [è®°å¿†çŠ¶æ€è¯´æ˜](#è®°å¿†çŠ¶æ€è¯´æ˜)
- [MCP è°ƒç”¨æ–¹å¼](#mcp-è°ƒç”¨æ–¹å¼)
- [è®°å¿†è¡°é€€åŠŸèƒ½è¯¦è§£](#è®°å¿†è¡°é€€åŠŸèƒ½è¯¦è§£)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## å¿«é€Ÿå¼€å§‹

### æœåŠ¡åœ°å€

- **API æœåŠ¡**: `http://localhost:8765`
- **API æ–‡æ¡£**: `http://localhost:8765/docs`
- **å‰ç«¯ç•Œé¢**: `http://localhost:3000`
- **MCP SSE ç«¯ç‚¹**: `http://localhost:8765/mcp/{client_name}/sse/{user_id}`

### è®¤è¯è¯´æ˜

å½“å‰ç‰ˆæœ¬ä½¿ç”¨ `user_id` ä½œä¸ºç”¨æˆ·æ ‡è¯†ï¼Œæ— éœ€é¢å¤–è®¤è¯ã€‚æ¯ä¸ªè¯·æ±‚éœ€è¦æä¾› `user_id` å‚æ•°ã€‚

---

## API è°ƒç”¨æ–¹å¼

### 1. è®°å¿†å­˜å‚¨

#### 1.1 åˆ›å»ºæ–°è®°å¿†

**æ¥å£**: `POST /api/v1/memories/`

**è¯·æ±‚ä½“**:
```json
{
  "user_id": "user123",
  "text": "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯ç¾å¼å’–å•¡",
  "metadata": {
    "category": "ä¸ªäººåå¥½",
    "tags": ["é¥®å“", "å’–å•¡"]
  },
  "infer": false,
  "app": "my_app"
}
```

**å‚æ•°è¯´æ˜**:
- `user_id` (å¿…å¡«): ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `text` (å¿…å¡«): è¦å­˜å‚¨çš„è®°å¿†å†…å®¹
- `metadata` (å¯é€‰): è‡ªå®šä¹‰å…ƒæ•°æ®
- `infer` (å¯é€‰): æ˜¯å¦æ¨æ–­ç›¸å…³ä¿¡æ¯ï¼Œé»˜è®¤ false
- `app` (å¯é€‰): åº”ç”¨åç§°ï¼Œé»˜è®¤ "openmemory"

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "uuid-of-user",
  "app_id": "uuid-of-app",
  "content": "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯ç¾å¼å’–å•¡",
  "state": "active",
  "created_at": "2025-12-31T03:00:00Z",
  "metadata_": {
    "category": "ä¸ªäººåå¥½",
    "tags": ["é¥®å“", "å’–å•¡"]
  },
  "decay_score": 1.0,
  "importance_score": 0.5,
  "access_count": 0
}
```

**cURL ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8765/api/v1/memories/" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user123",
    "text": "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯ç¾å¼å’–å•¡",
    "app": "my_app"
  }'
```

**Python ç¤ºä¾‹**:
```python
import requests

url = "http://localhost:8765/api/v1/memories/"
data = {
    "user_id": "user123",
    "text": "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯ç¾å¼å’–å•¡",
    "metadata": {
        "category": "ä¸ªäººåå¥½"
    },
    "app": "my_app"
}

response = requests.post(url, json=data)
memory = response.json()
print(f"è®°å¿†å·²åˆ›å»ºï¼ŒID: {memory['id']}")
```

---

### 2. è®°å¿†æŸ¥è¯¢

#### 2.1 åˆ—å‡ºæ‰€æœ‰è®°å¿†

**æ¥å£**: `GET /api/v1/memories/`

**æŸ¥è¯¢å‚æ•°**:
- `user_id` (å¿…å¡«): ç”¨æˆ·ID
- `app_id` (å¯é€‰): åº”ç”¨IDè¿‡æ»¤
- `from_date` (å¯é€‰): èµ·å§‹æ—¶é—´æˆ³
- `to_date` (å¯é€‰): ç»“æŸæ—¶é—´æˆ³
- `categories` (å¯é€‰): åˆ†ç±»è¿‡æ»¤ï¼Œé€—å·åˆ†éš”
- `search_query` (å¯é€‰): æœç´¢å…³é”®è¯
- `sort_column` (å¯é€‰): æ’åºå­—æ®µ (memory, categories, app_name, created_at)
- `sort_direction` (å¯é€‰): æ’åºæ–¹å‘ (asc, desc)
- `page` (å¯é€‰): é¡µç ï¼Œé»˜è®¤ 1
- `size` (å¯é€‰): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 10

**cURL ç¤ºä¾‹**:
```bash
# åŸºç¡€æŸ¥è¯¢
curl "http://localhost:8765/api/v1/memories/?user_id=user123&page=1&size=10"

# å¸¦æœç´¢å’Œæ’åº
curl "http://localhost:8765/api/v1/memories/?user_id=user123&search_query=å’–å•¡&sort_column=created_at&sort_direction=desc"
```

---

### 3. è®°å¿†æ›´æ–°

#### 3.1 æ›´æ–°è®°å¿†å†…å®¹

**æ¥å£**: `PUT /api/v1/memories/{memory_id}`

**è¯·æ±‚ä½“**:
```json
{
  "memory_content": "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯å†°ç¾å¼",
  "user_id": "user123"
}
```

---

### 4. è®°å¿†åˆ é™¤

#### 4.1 åˆ é™¤å¤šä¸ªè®°å¿†

**æ¥å£**: `DELETE /api/v1/memories/`

**è¯·æ±‚ä½“**:
```json
{
  "memory_ids": [
    "550e8400-e29b-41d4-a716-446655440000"
  ],
  "user_id": "user123"
}
```

---

### 5. è®°å¿†è¡°é€€ç®¡ç†

#### 5.1 æ‰‹åŠ¨è§¦å‘è¡°é€€æ›´æ–°

**æ¥å£**: `POST /api/v1/decay/trigger-update`

**è¯·æ±‚ä½“**:
```json
{
  "user_id": "user123",
  "half_life_days": 30,
  "auto_archive": true,
  "archive_threshold": 0.1
}
```

#### 5.2 æŸ¥è¯¢è¡°é€€ç»Ÿè®¡

**æ¥å£**: `GET /api/v1/decay/statistics?user_id=user123`

#### 5.3 æ›´æ–°è®°å¿†é‡è¦æ€§

**æ¥å£**: `POST /api/v1/decay/update-importance`

**è¯·æ±‚ä½“**:
```json
{
  "memory_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "user123",
  "importance_score": 0.9
}
```

#### 5.4 æŸ¥è¯¢è¡°é€€è®°å¿†åˆ—è¡¨

**æ¥å£**: `GET /api/v1/decay/decayed-memories?user_id=user123&threshold=0.3&limit=50`

---

### 6. å½’æ¡£è®°å¿†ç®¡ç†

å½’æ¡£è®°å¿†å­˜å‚¨åœ¨ç‹¬ç«‹çš„ `archived_memories` è¡¨ä¸­ï¼Œä¸æ´»è·ƒè®°å¿†å®Œå…¨åˆ†ç¦»ã€‚

#### 6.1 è·å–å½’æ¡£è®°å¿†åˆ—è¡¨

**æ¥å£**: `GET /api/v1/archived-memories/`

**æŸ¥è¯¢å‚æ•°**:
- `user_id` (å¿…å¡«): ç”¨æˆ·ID
- `limit` (å¯é€‰): è¿”å›æ•°é‡é™åˆ¶ï¼Œé»˜è®¤ 50ï¼Œæœ€å¤§ 500
- `offset` (å¯é€‰): åç§»é‡ï¼Œé»˜è®¤ 0

**cURL ç¤ºä¾‹**:
```bash
curl "http://localhost:8765/api/v1/archived-memories/?user_id=user123&limit=50&offset=0"
```

**å“åº”ç¤ºä¾‹**:
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "content": "è¿™æ˜¯ä¸€æ¡å½’æ¡£çš„è®°å¿†å†…å®¹...",
    "user_id": "uuid-of-user",
    "app_id": "uuid-of-app",
    "created_at": "2025-10-01T10:00:00Z",
    "archived_at": "2025-12-01T02:00:00Z",
    "decay_score_at_archive": 0.08,
    "importance_score": 0.5,
    "access_count": 2,
    "categories": ["ä¸ªäººåå¥½"]
  }
]
```

**Python ç¤ºä¾‹**:
```python
import requests

url = "http://localhost:8765/api/v1/archived-memories/"
params = {
    "user_id": "user123",
    "limit": 50,
    "offset": 0
}

response = requests.get(url, params=params)
archived_memories = response.json()
print(f"æ‰¾åˆ° {len(archived_memories)} æ¡å½’æ¡£è®°å¿†")
for memory in archived_memories:
    print(f"- {memory['content'][:50]}... (è¡°é€€åˆ†æ•°: {memory['decay_score_at_archive']})")
```

#### 6.2 è·å–å•ä¸ªå½’æ¡£è®°å¿†è¯¦æƒ…

**æ¥å£**: `GET /api/v1/archived-memories/{memory_id}?user_id=user123`

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "content": "å®Œæ•´çš„å½’æ¡£è®°å¿†å†…å®¹",
  "user_id": "uuid-of-user",
  "app_id": "uuid-of-app",
  "metadata": {
    "category": "ä¸ªäººåå¥½"
  },
  "created_at": "2025-10-01T10:00:00Z",
  "updated_at": "2025-11-15T08:30:00Z",
  "archived_at": "2025-12-01T02:00:00Z",
  "archived_from_state": "active",
  "decay_score_at_archive": 0.08,
  "last_accessed_at": "2025-11-15T08:30:00Z",
  "access_count": 2,
  "importance_score": 0.5,
  "categories": ["ä¸ªäººåå¥½"]
}
```

#### 6.3 æ¢å¤å½’æ¡£è®°å¿†

**æ¥å£**: `POST /api/v1/archived-memories/restore`

**è¯·æ±‚ä½“**:
```json
{
  "memory_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "user123"
}
```

**æ“ä½œè¯´æ˜**:
1. ä» `archived_memories` è¡¨åˆ é™¤è®°å½•
2. åœ¨ `memories` è¡¨åˆ›å»ºæ–°è®°å½•
3. é‡ç½®è¡°é€€åˆ†æ•°ä¸º 1.0ï¼ˆå®Œå…¨æ–°é²œï¼‰
4. æ¢å¤åˆ†ç±»å…³è”
5. çŠ¶æ€è®¾ç½®ä¸º `active`

**cURL ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8765/api/v1/archived-memories/restore" \
  -H "Content-Type: application/json" \
  -d '{
    "memory_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "user123"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "è®°å¿†å·²ä»å½’æ¡£è¡¨æ¢å¤åˆ°æ´»è·ƒè¡¨",
  "memory_id": "550e8400-e29b-41d4-a716-446655440000",
  "details": {
    "from_table": "archived_memories",
    "to_table": "memories",
    "new_decay_score": 1.0
  }
}
```

**Python ç¤ºä¾‹**:
```python
import requests

url = "http://localhost:8765/api/v1/archived-memories/restore"
data = {
    "memory_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "user123"
}

response = requests.post(url, json=data)
result = response.json()
if result['success']:
    print(f"è®°å¿†å·²æ¢å¤ï¼Œæ–°è¡°é€€åˆ†æ•°: {result['details']['new_decay_score']}")
```

#### 6.4 æ°¸ä¹…åˆ é™¤å½’æ¡£è®°å¿†

**æ¥å£**: `DELETE /api/v1/archived-memories/{memory_id}?user_id=user123`

**âš ï¸ è­¦å‘Š**: æ­¤æ“ä½œä¸å¯æ¢å¤ï¼å½’æ¡£è®°å¿†å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚

**cURL ç¤ºä¾‹**:
```bash
curl -X DELETE "http://localhost:8765/api/v1/archived-memories/550e8400-e29b-41d4-a716-446655440000?user_id=user123"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "å½’æ¡£è®°å¿†å·²æ°¸ä¹…åˆ é™¤",
  "memory_id": "550e8400-e29b-41d4-a716-446655440000",
  "warning": "æ­¤æ“ä½œä¸å¯æ¢å¤"
}
```

#### 6.5 è·å–å½’æ¡£ç»Ÿè®¡ä¿¡æ¯

**æ¥å£**: `GET /api/v1/archived-memories/stats/summary?user_id=user123`

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "total_archived": 25,
  "by_decay_score": {
    "very_low": 15,
    "low": 8,
    "medium": 2
  },
  "by_app": [
    {
      "app_id": "uuid-of-app1",
      "count": 15
    },
    {
      "app_id": "uuid-of-app2",
      "count": 10
    }
  ]
}
```

**è¡°é€€åˆ†æ•°ç­‰çº§è¯´æ˜**:
- `very_low`: < 0.05ï¼ˆæåº¦è¡°é€€ï¼‰
- `low`: 0.05 - 0.1ï¼ˆä¸¥é‡è¡°é€€ï¼‰
- `medium`: >= 0.1ï¼ˆä¸­ç­‰è¡°é€€ï¼‰

**Python ç¤ºä¾‹**:
```python
import requests

url = "http://localhost:8765/api/v1/archived-memories/stats/summary"
params = {"user_id": "user123"}

response = requests.get(url, params=params)
stats = response.json()

print(f"æ€»å½’æ¡£è®°å¿†æ•°: {stats['total_archived']}")
print(f"æåº¦è¡°é€€: {stats['by_decay_score']['very_low']}")
print(f"ä¸¥é‡è¡°é€€: {stats['by_decay_score']['low']}")
print(f"ä¸­ç­‰è¡°é€€: {stats['by_decay_score']['medium']}")
```

---

## è®°å¿†çŠ¶æ€è¯´æ˜

OpenMemory ä¸­çš„è®°å¿†æœ‰å¤šç§çŠ¶æ€ï¼Œå­˜å‚¨åœ¨ä¸åŒçš„è¡¨ä¸­ï¼š

### æ´»è·ƒè®°å¿† (Active Memories)

**å­˜å‚¨ä½ç½®**: `memories` è¡¨

**çŠ¶æ€**: `active`

**ç‰¹ç‚¹**:
- âœ… å¯ä»¥è¢«æœç´¢å’ŒæŸ¥è¯¢
- âœ… å‚ä¸ MCP å·¥å…·è°ƒç”¨
- âœ… ä¼šè¢«è¡°é€€æœºåˆ¶æ›´æ–°
- âœ… è¡°é€€åˆ†æ•° > å½’æ¡£é˜ˆå€¼ï¼ˆé»˜è®¤ 0.1ï¼‰

**æŸ¥è¯¢æ¥å£**:
```bash
# åˆ—å‡ºæ´»è·ƒè®°å¿†
curl "http://localhost:8765/api/v1/memories/?user_id=user123"

# æœç´¢æ´»è·ƒè®°å¿†
curl "http://localhost:8765/api/v1/memories/?user_id=user123&search_query=å’–å•¡"
```

### å½’æ¡£è®°å¿† (Archived Memories)

**å­˜å‚¨ä½ç½®**: `archived_memories` è¡¨ï¼ˆç‹¬ç«‹è¡¨ï¼‰

**çŠ¶æ€**: `archived`

**ç‰¹ç‚¹**:
- âŒ ä¸ä¼šå‡ºç°åœ¨å¸¸è§„æŸ¥è¯¢ä¸­
- âŒ ä¸å‚ä¸ MCP å·¥å…·è°ƒç”¨
- âŒ ä¸ä¼šè¢«è¡°é€€æœºåˆ¶æ›´æ–°
- âœ… å¯ä»¥éšæ—¶æ¢å¤åˆ°æ´»è·ƒçŠ¶æ€
- âœ… ä¿ç•™å®Œæ•´çš„å†å²ä¿¡æ¯
- ğŸ“Š è¡°é€€åˆ†æ•° <= å½’æ¡£é˜ˆå€¼ï¼ˆé»˜è®¤ 0.1ï¼‰

**æŸ¥è¯¢æ¥å£**:
```bash
# åˆ—å‡ºå½’æ¡£è®°å¿†
curl "http://localhost:8765/api/v1/archived-memories/?user_id=user123"

# è·å–å½’æ¡£ç»Ÿè®¡
curl "http://localhost:8765/api/v1/archived-memories/stats/summary?user_id=user123"
```

### æš‚åœè®°å¿† (Paused Memories)

**å­˜å‚¨ä½ç½®**: `memories` è¡¨

**çŠ¶æ€**: `paused`

**ç‰¹ç‚¹**:
- âŒ ä¸ä¼šå‡ºç°åœ¨å¸¸è§„æŸ¥è¯¢ä¸­
- âŒ ä¸å‚ä¸ MCP å·¥å…·è°ƒç”¨
- âœ… ä»åœ¨ memories è¡¨ä¸­
- âœ… å¯ä»¥æ¢å¤åˆ°æ´»è·ƒçŠ¶æ€

**æ“ä½œæ¥å£**:
```bash
# æš‚åœè®°å¿†
curl -X POST "http://localhost:8765/api/v1/memories/actions/pause" \
  -H "Content-Type: application/json" \
  -d '{
    "memory_ids": ["uuid1", "uuid2"],
    "user_id": "user123",
    "state": "paused"
  }'
```

### åˆ é™¤è®°å¿† (Deleted Memories)

**å­˜å‚¨ä½ç½®**: `memories` è¡¨

**çŠ¶æ€**: `deleted`

**ç‰¹ç‚¹**:
- âŒ ä¸ä¼šå‡ºç°åœ¨ä»»ä½•æŸ¥è¯¢ä¸­
- âŒ ä¸å‚ä¸ MCP å·¥å…·è°ƒç”¨
- âœ… ä»åœ¨ memories è¡¨ä¸­ï¼ˆè½¯åˆ é™¤ï¼‰
- âš ï¸ å¯ä»¥æ¢å¤ï¼Œä½†éœ€è¦ç‰¹æ®Šæ“ä½œ

**æ“ä½œæ¥å£**:
```bash
# åˆ é™¤è®°å¿†ï¼ˆè½¯åˆ é™¤ï¼‰
curl -X DELETE "http://localhost:8765/api/v1/memories/" \
  -H "Content-Type: application/json" \
  -d '{
    "memory_ids": ["uuid1"],
    "user_id": "user123"
  }'
```

### çŠ¶æ€è½¬æ¢æµç¨‹

```
åˆ›å»ºè®°å¿†
    â†“
[Active] â†â†’ [Paused]
    â†“
[Archived] (è¡°é€€åˆ†æ•° <= 0.1)
    â†“
å¯æ¢å¤åˆ° [Active]
    
[Active/Paused/Archived] â†’ [Deleted] (è½¯åˆ é™¤)
    
[Archived] â†’ æ°¸ä¹…åˆ é™¤ (ä» archived_memories è¡¨åˆ é™¤)
```

### çŠ¶æ€å¯¹æ¯”è¡¨

| çŠ¶æ€ | å­˜å‚¨è¡¨ | å¯æœç´¢ | MCPå¯ç”¨ | å¯æ¢å¤ | è¡°é€€æ›´æ–° |
|------|--------|--------|---------|--------|----------|
| Active | memories | âœ… | âœ… | - | âœ… |
| Paused | memories | âŒ | âŒ | âœ… | âŒ |
| Archived | archived_memories | âŒ | âŒ | âœ… | âŒ |
| Deleted | memories | âŒ | âŒ | âš ï¸ | âŒ |

### æœ€ä½³å®è·µ

#### 1. å®šæœŸæ£€æŸ¥å½’æ¡£è®°å¿†

```python
import requests

# è·å–å½’æ¡£ç»Ÿè®¡
url = "http://localhost:8765/api/v1/archived-memories/stats/summary"
response = requests.get(url, params={"user_id": "user123"})
stats = response.json()

if stats['total_archived'] > 100:
    print("âš ï¸ å½’æ¡£è®°å¿†è¿‡å¤šï¼Œå»ºè®®æ¸…ç†")
```

#### 2. æ¢å¤é‡è¦çš„å½’æ¡£è®°å¿†

```python
# æŸ¥çœ‹å½’æ¡£è®°å¿†åˆ—è¡¨
url = "http://localhost:8765/api/v1/archived-memories/"
response = requests.get(url, params={"user_id": "user123", "limit": 50})
archived = response.json()

# æ¢å¤é‡è¦è®°å¿†
for memory in archived:
    if memory['importance_score'] > 0.7:
        restore_url = "http://localhost:8765/api/v1/archived-memories/restore"
        requests.post(restore_url, json={
            "memory_id": memory['id'],
            "user_id": "user123"
        })
        print(f"å·²æ¢å¤é‡è¦è®°å¿†: {memory['content'][:50]}")
```

#### 3. æ¸…ç†æåº¦è¡°é€€çš„å½’æ¡£è®°å¿†

```python
# è·å–å½’æ¡£è®°å¿†
url = "http://localhost:8765/api/v1/archived-memories/"
response = requests.get(url, params={"user_id": "user123", "limit": 500})
archived = response.json()

# åˆ é™¤æåº¦è¡°é€€çš„è®°å¿†
for memory in archived:
    if memory['decay_score_at_archive'] < 0.03:
        delete_url = f"http://localhost:8765/api/v1/archived-memories/{memory['id']}"
        requests.delete(delete_url, params={"user_id": "user123"})
        print(f"å·²åˆ é™¤æåº¦è¡°é€€è®°å¿†: {memory['content'][:50]}")
```

#### 4. ç›‘æ§æ´»è·ƒè®°å¿†å’Œå½’æ¡£è®°å¿†çš„æ¯”ä¾‹

```python
import requests

# è·å–æ´»è·ƒè®°å¿†æ•°é‡
active_url = "http://localhost:8765/api/v1/memories/"
active_response = requests.get(active_url, params={"user_id": "user123", "size": 1})
active_count = active_response.json()['total']

# è·å–å½’æ¡£è®°å¿†æ•°é‡
archived_url = "http://localhost:8765/api/v1/archived-memories/stats/summary"
archived_response = requests.get(archived_url, params={"user_id": "user123"})
archived_count = archived_response.json()['total_archived']

# è®¡ç®—æ¯”ä¾‹
total = active_count + archived_count
if total > 0:
    active_ratio = active_count / total * 100
    archived_ratio = archived_count / total * 100
    print(f"æ´»è·ƒè®°å¿†: {active_count} ({active_ratio:.1f}%)")
    print(f"å½’æ¡£è®°å¿†: {archived_count} ({archived_ratio:.1f}%)")
    
    if archived_ratio > 50:
        print("âš ï¸ å½’æ¡£è®°å¿†å æ¯”è¿‡é«˜ï¼Œå»ºè®®è°ƒæ•´è¡°é€€ç­–ç•¥")
```

---

## MCP è°ƒç”¨æ–¹å¼

### MCP é…ç½®

#### é…ç½® Claude Desktop

```bash
npx install-mcp i http://localhost:8765/mcp/claude/sse/your_user_id --client claude
```

æˆ–æ‰‹åŠ¨é…ç½® `claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "openmemory": {
      "url": "http://localhost:8765/mcp/claude/sse/your_user_id",
      "transport": "sse"
    }
  }
}
```

### MCP å·¥å…·ä½¿ç”¨

MCP æä¾›äº† 4 ä¸ªæ ¸å¿ƒå·¥å…·ï¼ŒAI å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è°ƒç”¨ï¼š

1. **add_memories**: æ·»åŠ æ–°è®°å¿†
2. **search_memory**: æœç´¢è®°å¿†
3. **list_memories**: åˆ—å‡ºæ‰€æœ‰è®°å¿†
4. **delete_all_memories**: åˆ é™¤æ‰€æœ‰è®°å¿†

---

## è®°å¿†è¡°é€€åŠŸèƒ½è¯¦è§£

### è¡°é€€æœºåˆ¶

è®°å¿†è¡°é€€æ¨¡æ‹Ÿäººç±»è®°å¿†çš„è‡ªç„¶é—å¿˜è¿‡ç¨‹ï¼š

#### è¡°é€€åˆ†æ•°è®¡ç®—å…¬å¼

```
è¡°é€€åˆ†æ•° = æ—¶é—´è¡°å‡ Ã— è®¿é—®åŠ æˆ Ã— é‡è¦æ€§æƒé‡
```

**æ—¶é—´è¡°å‡**ï¼ˆåŸºäºåŠè¡°æœŸï¼‰:
```
æ—¶é—´è¡°å‡ = 0.5^(å¤©æ•° / åŠè¡°æœŸ)
```

**è®¿é—®åŠ æˆ**ï¼ˆè®¿é—®è¶Šå¤šï¼Œè¡°å‡è¶Šæ…¢ï¼‰:
```
è®¿é—®åŠ æˆ = 1.0 + log(1 + è®¿é—®æ¬¡æ•°) Ã— 0.2
```

**é‡è¦æ€§æƒé‡**:
```
é‡è¦æ€§æƒé‡ = 0.5 + (é‡è¦æ€§åˆ†æ•° Ã— 0.5)
```

### è¡°é€€ç­‰çº§

- **é«˜åˆ† (0.7-1.0)**: æ–°é²œè®°å¿†ï¼Œæ´»è·ƒä½¿ç”¨
- **ä¸­ç­‰ (0.3-0.7)**: ä¸­ç­‰è¡°é€€ï¼Œå¶å°”ä½¿ç”¨
- **ä½åˆ† (0.0-0.3)**: ä¸¥é‡è¡°é€€ï¼Œå¾ˆå°‘ä½¿ç”¨

### è‡ªåŠ¨å½’æ¡£

å½“è¡°é€€åˆ†æ•°ä½äºé˜ˆå€¼ï¼ˆé»˜è®¤ 0.1ï¼‰æ—¶ï¼Œè®°å¿†ä¼šè‡ªåŠ¨å½’æ¡£ï¼š

- å½’æ¡£çš„è®°å¿†ä¸ä¼šå‡ºç°åœ¨å¸¸è§„æŸ¥è¯¢ä¸­
- å½’æ¡£çš„è®°å¿†å¯ä»¥éšæ—¶æ¢å¤
- å½’æ¡£ä¸ç­‰äºåˆ é™¤ï¼Œæ•°æ®ä»ç„¶ä¿ç•™

### é…ç½®è¡°é€€åŠŸèƒ½

åœ¨ `api/.env` ä¸­é…ç½®ï¼š

```env
# å¯ç”¨è®°å¿†è¡°é€€
MEMORY_DECAY_ENABLED=true

# åŠè¡°æœŸï¼š30å¤©
MEMORY_DECAY_HALF_LIFE_DAYS=30

# è‡ªåŠ¨å½’æ¡£é˜ˆå€¼ï¼š0.1
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.1

# æ›´æ–°æ—¶é—´ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹
MEMORY_DECAY_UPDATE_HOUR=2
MEMORY_DECAY_UPDATE_MINUTE=0
```

### åŠè¡°æœŸæ¨èå€¼

- **7å¤©**: å¿«é€Ÿè¡°é€€ï¼Œé€‚åˆä¸´æ—¶ä¿¡æ¯
- **30å¤©**: æ ‡å‡†è¡°é€€ï¼Œé€‚åˆä¸€èˆ¬ä½¿ç”¨ï¼ˆæ¨èï¼‰
- **90å¤©**: æ…¢é€Ÿè¡°é€€ï¼Œé€‚åˆé•¿æœŸè®°å¿†
- **180å¤©**: ææ…¢è¡°é€€ï¼Œé€‚åˆé‡è¦ä¿¡æ¯

---

## å®Œæ•´ç¤ºä¾‹

### Python å®Œæ•´ç¤ºä¾‹ï¼ˆåŒ…å«å½’æ¡£è®°å¿†ç®¡ç†ï¼‰

```python
import requests

class OpenMemoryClient:
    def __init__(self, base_url="http://localhost:8765", user_id="user123"):
        self.base_url = base_url
        self.user_id = user_id
        self.app = "my_app"
    
    def add_memory(self, text, metadata=None):
        """æ·»åŠ æ–°è®°å¿†"""
        url = f"{self.base_url}/api/v1/memories/"
        data = {
            "user_id": self.user_id,
            "text": text,
            "metadata": metadata or {},
            "app": self.app
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def search_memories(self, query):
        """æœç´¢è®°å¿†"""
        url = f"{self.base_url}/api/v1/memories/"
        params = {
            "user_id": self.user_id,
            "search_query": query,
            "page": 1,
            "size": 10
        }
        response = requests.get(url, params=params)
        return response.json()
    
    def trigger_decay_update(self, half_life_days=30, auto_archive=True, threshold=0.1):
        """è§¦å‘è¡°é€€æ›´æ–°"""
        url = f"{self.base_url}/api/v1/decay/trigger-update"
        data = {
            "user_id": self.user_id,
            "half_life_days": half_life_days,
            "auto_archive": auto_archive,
            "archive_threshold": threshold
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def get_decay_statistics(self):
        """è·å–è¡°é€€ç»Ÿè®¡"""
        url = f"{self.base_url}/api/v1/decay/statistics"
        params = {"user_id": self.user_id}
        response = requests.get(url, params=params)
        return response.json()
    
    def update_importance(self, memory_id, importance_score):
        """æ›´æ–°è®°å¿†é‡è¦æ€§"""
        url = f"{self.base_url}/api/v1/decay/update-importance"
        data = {
            "memory_id": memory_id,
            "user_id": self.user_id,
            "importance_score": importance_score
        }
        response = requests.post(url, json=data)
        return response.json()
    
    # === å½’æ¡£è®°å¿†ç®¡ç† ===
    
    def list_archived_memories(self, limit=50, offset=0):
        """è·å–å½’æ¡£è®°å¿†åˆ—è¡¨"""
        url = f"{self.base_url}/api/v1/archived-memories/"
        params = {
            "user_id": self.user_id,
            "limit": limit,
            "offset": offset
        }
        response = requests.get(url, params=params)
        return response.json()
    
    def get_archived_memory(self, memory_id):
        """è·å–å•ä¸ªå½’æ¡£è®°å¿†è¯¦æƒ…"""
        url = f"{self.base_url}/api/v1/archived-memories/{memory_id}"
        params = {"user_id": self.user_id}
        response = requests.get(url, params=params)
        return response.json()
    
    def restore_archived_memory(self, memory_id):
        """æ¢å¤å½’æ¡£è®°å¿†"""
        url = f"{self.base_url}/api/v1/archived-memories/restore"
        data = {
            "memory_id": memory_id,
            "user_id": self.user_id
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def delete_archived_memory(self, memory_id):
        """æ°¸ä¹…åˆ é™¤å½’æ¡£è®°å¿†"""
        url = f"{self.base_url}/api/v1/archived-memories/{memory_id}"
        params = {"user_id": self.user_id}
        response = requests.delete(url, params=params)
        return response.json()
    
    def get_archived_stats(self):
        """è·å–å½’æ¡£ç»Ÿè®¡ä¿¡æ¯"""
        url = f"{self.base_url}/api/v1/archived-memories/stats/summary"
        params = {"user_id": self.user_id}
        response = requests.get(url, params=params)
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    client = OpenMemoryClient(user_id="demo_user")
    
    # 1. æ·»åŠ è®°å¿†
    print("=== æ·»åŠ è®°å¿† ===")
    memory1 = client.add_memory(
        "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯ç¾å¼å’–å•¡",
        metadata={"category": "ä¸ªäººåå¥½"}
    )
    print(f"è®°å¿†å·²åˆ›å»º: {memory1['id']}")
    
    # 2. æœç´¢è®°å¿†
    print("\n=== æœç´¢è®°å¿† ===")
    results = client.search_memories("å’–å•¡")
    print(f"æ‰¾åˆ° {results['total']} æ¡ç›¸å…³è®°å¿†")
    
    # 3. æ›´æ–°é‡è¦æ€§
    print("\n=== æ›´æ–°é‡è¦æ€§ ===")
    importance_result = client.update_importance(
        memory1['id'],
        importance_score=0.9
    )
    print(f"é‡è¦æ€§å·²æ›´æ–°: {importance_result['new_importance']}")
    
    # 4. è·å–è¡°é€€ç»Ÿè®¡
    print("\n=== è¡°é€€ç»Ÿè®¡ ===")
    stats = client.get_decay_statistics()
    print(f"æ€»è®°å¿†æ•°: {stats['statistics']['total_memories']}")
    print(f"å¹³å‡è¡°é€€åˆ†æ•°: {stats['statistics']['average_decay_score']}")
    
    # 5. è§¦å‘è¡°é€€æ›´æ–°
    print("\n=== è§¦å‘è¡°é€€æ›´æ–° ===")
    update_result = client.trigger_decay_update(
        half_life_days=30,
        auto_archive=True,
        threshold=0.1
    )
    print(f"æ›´æ–°äº† {update_result['updated_count']} æ¡è®°å¿†")
    print(f"å½’æ¡£äº† {update_result['archived_count']} æ¡è®°å¿†")
    
    # 6. å½’æ¡£è®°å¿†ç®¡ç†
    print("\n=== å½’æ¡£è®°å¿†ç®¡ç† ===")
    
    # è·å–å½’æ¡£ç»Ÿè®¡
    archived_stats = client.get_archived_stats()
    print(f"æ€»å½’æ¡£è®°å¿†æ•°: {archived_stats['total_archived']}")
    print(f"æåº¦è¡°é€€: {archived_stats['by_decay_score']['very_low']}")
    
    # åˆ—å‡ºå½’æ¡£è®°å¿†
    archived_list = client.list_archived_memories(limit=10)
    print(f"å½’æ¡£è®°å¿†åˆ—è¡¨: {len(archived_list)} æ¡")
    
    # æ¢å¤ç¬¬ä¸€æ¡å½’æ¡£è®°å¿†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if archived_list:
        first_archived = archived_list[0]
        print(f"\næ¢å¤å½’æ¡£è®°å¿†: {first_archived['content'][:50]}...")
        restore_result = client.restore_archived_memory(first_archived['id'])
        print(f"æ¢å¤æˆåŠŸï¼Œæ–°è¡°é€€åˆ†æ•°: {restore_result['details']['new_decay_score']}")
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é€‰æ‹©åˆé€‚çš„åŠè¡°æœŸï¼Ÿ

**A**: æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ï¼š
- **ä¸´æ—¶ä¿¡æ¯**ï¼ˆèŠå¤©è®°å½•ï¼‰: 7-14å¤©
- **ä¸€èˆ¬ä¿¡æ¯**ï¼ˆæ—¥å¸¸è®°å¿†ï¼‰: 30å¤©ï¼ˆæ¨èï¼‰
- **é‡è¦ä¿¡æ¯**ï¼ˆå·¥ä½œçŸ¥è¯†ï¼‰: 90-180å¤©

### Q2: è¡°é€€åŠŸèƒ½ä¼šåˆ é™¤è®°å¿†å—ï¼Ÿ

**A**: ä¸ä¼šã€‚è¡°é€€åŠŸèƒ½åªä¼šå°†è®°å¿†æ ‡è®°ä¸º"å½’æ¡£"çŠ¶æ€ï¼Œå¯ä»¥éšæ—¶æ¢å¤ã€‚çœŸæ­£çš„åˆ é™¤éœ€è¦æ‰‹åŠ¨è°ƒç”¨åˆ é™¤æ¥å£ã€‚

### Q3: å¦‚ä½•é˜²æ­¢é‡è¦è®°å¿†è¢«å½’æ¡£ï¼Ÿ

**A**: æœ‰ä¸¤ç§æ–¹æ³•ï¼š
1. è®¾ç½®é«˜é‡è¦æ€§åˆ†æ•°ï¼ˆ0.8-1.0ï¼‰
2. ç»å¸¸è®¿é—®è¯¥è®°å¿†ï¼ˆè®¿é—®ä¼šæé«˜è¡°é€€åˆ†æ•°ï¼‰

### Q4: MCP å’Œ API æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**: 
- **MCP**: ä¾› AI å®¢æˆ·ç«¯ï¼ˆClaudeã€Cursorç­‰ï¼‰è‡ªåŠ¨è°ƒç”¨ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒç»†èŠ‚
- **API**: ä¾›å¼€å‘è€…ç›´æ¥è°ƒç”¨ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶æ‰€æœ‰å‚æ•°

### Q5: å¦‚ä½•æŸ¥çœ‹è®°å¿†çš„è¡°é€€åˆ†æ•°ï¼Ÿ

**A**: é€šè¿‡ API è·å–è®°å¿†è¯¦æƒ…æ—¶ä¼šè¿”å› `decay_score` å­—æ®µï¼Œæˆ–è€…åœ¨å‰ç«¯ç•Œé¢æŸ¥çœ‹ã€‚

### Q6: å½’æ¡£é˜ˆå€¼è®¾ç½®å¤šå°‘åˆé€‚ï¼Ÿ

**A**: 
- **0.05**: æ¿€è¿›å½’æ¡£ï¼Œä¿æŒç³»ç»Ÿç²¾ç®€
- **0.1**: æ ‡å‡†å½’æ¡£ï¼ˆæ¨èï¼‰
- **0.2**: ä¿å®ˆå½’æ¡£ï¼Œä¿ç•™æ›´å¤šè®°å¿†

### Q7: å½’æ¡£è®°å¿†å’Œåˆ é™¤è®°å¿†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**: 
- **å½’æ¡£è®°å¿†**: å­˜å‚¨åœ¨ç‹¬ç«‹çš„ `archived_memories` è¡¨ä¸­ï¼Œå¯ä»¥éšæ—¶æ¢å¤åˆ°æ´»è·ƒçŠ¶æ€ï¼Œè¡°é€€åˆ†æ•°ä¼šé‡ç½®ä¸º 1.0
- **åˆ é™¤è®°å¿†**: åœ¨ `memories` è¡¨ä¸­æ ‡è®°ä¸º `deleted` çŠ¶æ€ï¼ˆè½¯åˆ é™¤ï¼‰ï¼Œä¸ä¼šå‡ºç°åœ¨æŸ¥è¯¢ä¸­ï¼Œä½†æ•°æ®ä»ç„¶ä¿ç•™
- **æ°¸ä¹…åˆ é™¤**: ä» `archived_memories` è¡¨ä¸­ç‰©ç†åˆ é™¤ï¼Œä¸å¯æ¢å¤

### Q8: å½’æ¡£è®°å¿†ä¼šå ç”¨æœç´¢æ€§èƒ½å—ï¼Ÿ

**A**: ä¸ä¼šã€‚å½’æ¡£è®°å¿†å­˜å‚¨åœ¨ç‹¬ç«‹çš„è¡¨ä¸­ï¼Œä¸ä¼šå½±å“æ´»è·ƒè®°å¿†çš„æŸ¥è¯¢æ€§èƒ½ã€‚

### Q9: å¦‚ä½•æ‰¹é‡æ¢å¤å½’æ¡£è®°å¿†ï¼Ÿ

**A**: å¯ä»¥å…ˆè·å–å½’æ¡£è®°å¿†åˆ—è¡¨ï¼Œç„¶åå¾ªç¯è°ƒç”¨æ¢å¤æ¥å£ï¼š
```python
archived = client.list_archived_memories(limit=100)
for memory in archived:
    if memory['importance_score'] > 0.7:  # åªæ¢å¤é‡è¦è®°å¿†
        client.restore_archived_memory(memory['id'])
```

### Q10: å½’æ¡£è®°å¿†ä¼šè¢« MCP å·¥å…·è®¿é—®å—ï¼Ÿ

**A**: ä¸ä¼šã€‚MCP å·¥å…·ï¼ˆsearch_memoryã€list_memoriesï¼‰åªèƒ½è®¿é—®æ´»è·ƒçŠ¶æ€çš„è®°å¿†ï¼Œå½’æ¡£è®°å¿†éœ€è¦é€šè¿‡ä¸“é—¨çš„ API æ¥å£è®¿é—®ã€‚

---

## ç›¸å…³èµ„æº

- **API æ–‡æ¡£**: http://localhost:8765/docs
- **å‰ç«¯ç•Œé¢**: http://localhost:3000
- **è¯¦ç»†ä½¿ç”¨æŒ‡å—**: `README_è¯¦ç»†ä½¿ç”¨æŒ‡å—.md`
- **è¡°é€€åŠŸèƒ½æŒ‡å—**: `è®°å¿†è¡°é€€åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md`
- **å¿«é€Ÿå¼€å§‹**: `å¿«é€Ÿå¼€å§‹.md`

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ API æ–‡æ¡£: http://localhost:8765/docs
2. æŸ¥çœ‹æ—¥å¿—: `docker compose logs -f openmemory-api`
3. æäº¤ Issue åˆ° GitHub

---

**ç¥ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰**
