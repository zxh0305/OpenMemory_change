# 记忆衰退功能 - 快速部署指南 ⚡

## 🎯 5分钟快速部署

### 步骤 1：更新依赖

```bash
# 进入 API 容器
docker compose exec openmemory-api bash

# 安装新依赖
pip install APScheduler>=3.10.0

# 退出容器
exit
```

### 步骤 2：运行数据库迁移

```bash
# 进入 API 容器
docker compose exec openmemory-api bash

# 运行迁移（添加衰退相关字段）
alembic upgrade head

# 退出容器
exit
```

### 步骤 3：配置环境变量

编辑 `api/.env` 文件，添加以下配置：

```env
# 启用记忆衰退功能
MEMORY_DECAY_ENABLED=true

# 半衰期：30天
MEMORY_DECAY_HALF_LIFE_DAYS=30

# 自动归档阈值：0.1
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.1

# 更新时间：每天凌晨2点
MEMORY_DECAY_UPDATE_HOUR=2
MEMORY_DECAY_UPDATE_MINUTE=0
```

### 步骤 4：重启服务

```bash
# 重启 API 服务
docker compose restart openmemory-api

# 查看日志确认启动成功
docker compose logs -f openmemory-api
```

看到以下日志表示成功：
```
🚀 记忆衰退调度器已启动
⏰ 更新时间: 每天 02:00
📅 半衰期: 30 天
📦 归档阈值: 0.1
```

---

## ✅ 验证部署

### 1. 检查调度器状态

```bash
curl "http://localhost:8765/api/v1/decay/scheduler-status"
```

预期响应：
```json
{
  "success": true,
  "scheduler": {
    "enabled": true,
    "running": true,
    "next_run_time": "2025-12-04T02:00:00",
    ...
  }
}
```

### 2. 手动触发测试

```bash
curl -X POST "http://localhost:8765/api/v1/decay/trigger-update" \
  -H "Content-Type: application/json" \
  -d '{
    "half_life_days": 30,
    "auto_archive": false
  }'
```

### 3. 查看统计信息

```bash
curl "http://localhost:8765/api/v1/decay/statistics"
```

---

## 📁 已创建的文件

### 核心功能文件
1. ✅ `api/app/models.py` - 添加了衰退相关字段
2. ✅ `api/app/utils/decay.py` - 衰退计算核心算法
3. ✅ `api/app/tasks/decay_scheduler.py` - 定时任务调度器
4. ✅ `api/app/tasks/__init__.py` - 任务模块初始化
5. ✅ `api/app/routers/decay.py` - API 路由
6. ✅ `api/alembic/versions/add_memory_decay_fields.py` - 数据库迁移

### 配置文件
7. ✅ `api/main.py` - 集成调度器启动逻辑
8. ✅ `api/requirements.txt` - 添加 APScheduler 依赖
9. ✅ `api/.env.example` - 添加配置示例

### 文档文件
10. ✅ `记忆衰退功能使用指南.md` - 完整使用文档
11. ✅ `记忆衰退功能-快速部署.md` - 本文件

---

## 🔧 配置说明

### 推荐配置（不同场景）

#### 个人使用
```env
MEMORY_DECAY_ENABLED=true
MEMORY_DECAY_HALF_LIFE_DAYS=60
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.15
```

#### 团队协作
```env
MEMORY_DECAY_ENABLED=true
MEMORY_DECAY_HALF_LIFE_DAYS=30
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.1
```

#### 学习助手
```env
MEMORY_DECAY_ENABLED=true
MEMORY_DECAY_HALF_LIFE_DAYS=14
MEMORY_DECAY_AUTO_ARCHIVE_THRESHOLD=0.2
```

---

## 🎨 核心功能

### 1. 自动衰退计算
- 基于时间的指数衰减
- 访问频率加成
- 重要性权重调整

### 2. 定时任务
- 每天自动更新衰退分数
- 自动归档衰退记忆
- 可配置执行时间

### 3. API 接口
- 手动触发更新
- 查询统计信息
- 调整记忆重要性
- 恢复归档记忆

### 4. 灵活配置
- 可调整半衰期
- 可调整归档阈值
- 可启用/禁用功能

---

## 📊 数据库变更

新增字段（已通过迁移自动添加）：

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| decay_score | Float | 1.0 | 衰退分数 (0-1) |
| last_accessed_at | DateTime | NULL | 最后访问时间 |
| access_count | Integer | 0 | 访问次数 |
| importance_score | Float | 0.5 | 重要性分数 (0-1) |

新增索引：
- `idx_memory_decay_score`
- `idx_memory_last_accessed`
- `idx_memory_importance`
- `idx_memory_state_decay`

---

## 🚨 注意事项

### 1. 数据备份
在运行迁移前，建议备份数据库：
```bash
# SQLite 备份
cp api/openmemory.db api/openmemory.db.backup

# MySQL 备份
docker compose exec openmemory-api mysqldump -u user -p openmemory > backup.sql
```

### 2. 性能考虑
- 大规模数据（>10万条）建议在低峰期运行迁移
- 可调整批处理大小优化性能
- 建议在凌晨执行定时任务

### 3. 兼容性
- 需要 Python 3.8+
- 需要 APScheduler 3.10.0+
- 兼容 SQLite、MySQL、PostgreSQL

---

## 🔍 故障排查

### 问题：迁移失败

**解决方案**：
```bash
# 查看当前迁移版本
docker compose exec openmemory-api alembic current

# 查看迁移历史
docker compose exec openmemory-api alembic history

# 回滚到上一版本
docker compose exec openmemory-api alembic downgrade -1

# 重新运行迁移
docker compose exec openmemory-api alembic upgrade head
```

### 问题：调度器未启动

**检查步骤**：
1. 确认 `MEMORY_DECAY_ENABLED=true`
2. 查看启动日志
3. 检查 APScheduler 是否安装
4. 重启服务

### 问题：API 接口 404

**解决方案**：
- 确认已重启服务
- 检查路由是否正确导入
- 查看 API 文档：http://localhost:8765/docs

---

## 📚 下一步

1. **阅读完整文档**：`记忆衰退功能使用指南.md`
2. **测试 API 接口**：访问 http://localhost:8765/docs
3. **调整配置参数**：根据实际需求优化
4. **监控运行状态**：定期查看统计信息

---

## 🎉 部署完成！

记忆衰退功能已成功部署，现在你的 OpenMemory 具备了：

✅ 自动记忆管理
✅ 智能衰退计算
✅ 定时任务调度
✅ 完整 API 接口
✅ 灵活配置选项

开始享受更智能的记忆管理体验吧！🚀

---

**需要帮助？**
- 查看完整文档：`记忆衰退功能使用指南.md`
- 查看 API 文档：http://localhost:8765/docs
- 提交 Issue：GitHub Issues